<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wallet Top-up Test</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; max-width: 900px; background: #f3f4f6; }
        h1, h2, h3 { color: #111827; }
        .card { background: #ffffff; border-radius: 0.75rem; padding: 1.75rem; box-shadow: 0 10px 25px rgba(15,23,42,0.08); border: 1px solid #e5e7eb; }
        label { display: block; margin-top: 1rem; font-weight: 500; color: #374151; }
        input, textarea, button { margin-top: 0.25rem; padding: 0.55rem 0.75rem; font-size: 0.95rem; border-radius: 0.5rem; border: 1px solid #d1d5db; width: 100%; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 3rem; }
        input:focus, textarea:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 1px rgba(79,70,229,0.4); }
        button { cursor: pointer; background: #4f46e5; color: white; font-weight: 600; border: none; margin-top: 1rem; }
        button:hover { background: #4338ca; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        pre { background: #111827; color: #e5e7eb; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; font-size: 0.85rem; line-height: 1.4; margin-top: 1rem; }
        .row { margin-bottom: 1.25rem; }
        .pill { display: inline-block; padding: 0.15rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: #eef2ff; color: #3730a3; margin-left: 0.5rem; }
        .status { margin-top: 0.5rem; font-size: 0.85rem; }
        .status span { padding: 0.15rem 0.5rem; border-radius: 999px; }
        .status-idle span { background: #f3f4f6; color: #4b5563; }
        .status-loading span { background: #eff6ff; color: #1d4ed8; }
        .status-success span { background: #ecfdf5; color: #15803d; }
        .status-error span { background: #fef2f2; color: #b91c1c; }
        .stack { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
    </style>
</head>
<body>
<h1>Wallet Top-up Test</h1>
<p>Use this page to test the <code>WALLET_DEPOSIT</code> payment flow against your backend.</p>

<div class="card">
    <h2>Configuration</h2>
    <div class="row">
        <label>
            API Base URL
            <span class="pill">e.g. http://localhost:8080</span>
            <input id="baseUrl" type="text" value="http://localhost:8080" />
        </label>
    </div>

    <div class="row">
        <label>
            JWT Token (Bearer)
            <textarea id="jwt" rows="3" placeholder="Paste your JWT here"></textarea>
        </label>
    </div>

    <div class="row">
        <label>
            X-User-Role-Id
            <span class="pill">optional role context header</span>
            <input id="userRoleId" type="text" placeholder="UUID of user role (optional)" />
        </label>
    </div>

    <h2>Top-up Details</h2>
    <div class="row">
        <label>
            Amount
            <input id="amount" type="number" step="0.01" min="0.01" value="5.00" />
        </label>
    </div>

    <div class="row">
        <label>
            Description (optional)
            <input id="description" type="text" value="Wallet funding test" />
        </label>
    </div>

    <div class="stack">
        <button id="createIntentBtn">1. Create <code>WALLET_DEPOSIT</code> intent</button>
        <div class="status status-idle" id="intentStatus"><span>Idle</span></div>
    </div>

    <div class="row">
        <label>
            Payment Intent ID
            <input id="paymentIntentId" type="text" readonly />
        </label>
    </div>

    <div class="stack">
        <button id="confirmPaymentBtn">2. Confirm payment</button>
        <div class="status status-idle" id="confirmStatus"><span>Idle</span></div>
    </div>

    <h3>Last response</h3>
    <pre id="output">{}</pre>
</div>

<script>
    const $ = (id) => document.getElementById(id);

    function setStatus(el, mode, text) {
        el.className = 'status status-' + mode;
        el.querySelector('span').textContent = text;
    }

    function getHeaders() {
        const jwt = $('jwt').value.trim();
        const headers = { 'Content-Type': 'application/json' };
        if (jwt) {
            headers['Authorization'] = 'Bearer ' + jwt;
        }
        const roleId = $('userRoleId').value.trim();
        if (roleId) {
            headers['X-User-Role-Id'] = roleId;
        }
        return headers;
    }

    function logResponse(data) {
        $('output').textContent = JSON.stringify(data, null, 2);
        console.log('[Wallet top-up test]', data);
    }

    $('createIntentBtn').addEventListener('click', async () => {
        const baseUrl = $('baseUrl').value.replace(/\/+$/, '');
        const amount = parseFloat($('amount').value);
        const description = $('description').value;
        const statusEl = $('intentStatus');

        if (!amount || amount <= 0) {
            alert('Amount must be > 0');
            return;
        }

        const body = {
            amount: amount,
            type: 'WALLET_DEPOSIT',
            description: description || null
        };

        setStatus(statusEl, 'loading', 'Creating intent...');

        try {
            const res = await fetch(baseUrl + '/api/v1/payments/intent', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(body)
            });

            const data = await res.json().catch(() => ({}));
            logResponse(data);

            if (!res.ok) {
                setStatus(statusEl, 'error', 'Error: ' + (data?.message || res.status));
                alert('Error creating payment intent (see response below)');
                return;
            }

            const paymentIntentId = data?.data?.paymentIntentId;
            if (paymentIntentId) {
                $('paymentIntentId').value = paymentIntentId;
                setStatus(statusEl, 'success', 'Intent created: ' + paymentIntentId);
            } else {
                setStatus(statusEl, 'error', 'No paymentIntentId in response');
                alert('No paymentIntentId found in response');
            }
        } catch (err) {
            console.error(err);
            logResponse({ error: err.message || String(err) });
            setStatus(statusEl, 'error', 'Error: ' + (err.message || 'Unknown'));
        }
    });

    $('confirmPaymentBtn').addEventListener('click', async () => {
        const baseUrl = $('baseUrl').value.replace(/\/+$/, '');
        const paymentIntentId = $('paymentIntentId').value.trim();
        const statusEl = $('confirmStatus');

        if (!paymentIntentId) {
            alert('Create a payment intent first (step 1).');
            return;
        }

        setStatus(statusEl, 'loading', 'Confirming payment...');

        try {
            const res = await fetch(
                baseUrl + '/api/v1/payments/confirm/' + encodeURIComponent(paymentIntentId),
                {
                    method: 'POST',
                    headers: getHeaders()
                }
            );

            const data = await res.json().catch(() => ({}));
            logResponse(data);

            if (!res.ok) {
                setStatus(statusEl, 'error', 'Error: ' + (data?.message || res.status));
                alert('Error confirming payment (see response below)');
                return;
            }

            setStatus(statusEl, 'success', 'Payment confirmed');
            alert('Payment confirmed. Wallet should now be topped up.');
        } catch (err) {
            console.error(err);
            logResponse({ error: err.message || String(err) });
            setStatus(statusEl, 'error', 'Error: ' + (err.message || 'Unknown'));
        }
    });
</script>

</body>
</html>


